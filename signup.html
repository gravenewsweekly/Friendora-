<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendora.space - Sign Up</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Friendora.space</h1>
            <p>Connect with friends around the world</p>
        </header>
        
        <main>
            <form id="signupForm" class="signup-form">
                <h2>Create Your Account</h2>
                
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required minlength="4" maxlength="20">
                    <div id="usernameError" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                    <div id="emailError" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required minlength="8">
                    <div class="password-requirements">
                        Password must be at least 8 characters long
                    </div>
                </div>
                
                <button type="submit" id="signupButton" class="btn">Sign Up</button>
                
                <div class="login-link">
                    Already have an account? <a href="login.html">Log in</a>
                </div>
            </form>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const signupForm = document.getElementById('signupForm');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const usernameError = document.getElementById('usernameError');
            const emailError = document.getElementById('emailError');
            const signupButton = document.getElementById('signupButton');
            
            // JSONBin.io configuration
            const BIN_ID = '67e6fe048561e97a50f4cd0e';
            const API_KEY = '$2a$10$SjwPaeKPooM.8FtccKflzOGhqHNe7Vfm/9zjH9q9fH2AkZLZsQf02';
            const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
            
            // Check if username is available
            async function checkUsernameAvailability(username) {
                try {
                    const response = await fetch(API_URL + '/latest', {
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch user data');
                    
                    const data = await response.json();
                    const users = data.record.users || [];
                    
                    return !users.some(user => user.username.toLowerCase() === username.toLowerCase());
                } catch (error) {
                    console.error('Error checking username:', error);
                    return false;
                }
            }
            
            // Check if email is available
            async function checkEmailAvailability(email) {
                try {
                    const response = await fetch(API_URL + '/latest', {
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch user data');
                    
                    const data = await response.json();
                    const users = data.record.users || [];
                    
                    return !users.some(user => user.email.toLowerCase() === email.toLowerCase());
                } catch (error) {
                    console.error('Error checking email:', error);
                    return false;
                }
            }
            
            // Validate username on blur
            usernameInput.addEventListener('blur', async function() {
                const username = usernameInput.value.trim();
                if (username.length < 4) {
                    usernameError.textContent = 'Username must be at least 4 characters';
                    return;
                }
                
                const isAvailable = await checkUsernameAvailability(username);
                if (!isAvailable) {
                    usernameError.textContent = 'Username is already taken';
                } else {
                    usernameError.textContent = '';
                }
            });
            
            // Validate email on blur
            emailInput.addEventListener('blur', async function() {
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email)) {
                    emailError.textContent = 'Please enter a valid email address';
                    return;
                }
                
                const isAvailable = await checkEmailAvailability(email);
                if (!isAvailable) {
                    emailError.textContent = 'Email is already registered';
                } else {
                    emailError.textContent = '';
                }
            });
            
            // Form submission
            signupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                signupButton.disabled = true;
                signupButton.textContent = 'Creating account...';
                
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                // Validate inputs
                if (username.length < 4) {
                    usernameError.textContent = 'Username must be at least 4 characters';
                    signupButton.disabled = false;
                    signupButton.textContent = 'Sign Up';
                    return;
                }
                
                if (password.length < 8) {
                    alert('Password must be at least 8 characters long');
                    signupButton.disabled = false;
                    signupButton.textContent = 'Sign Up';
                    return;
                }
                
                // Check availability one more time before submitting
                const [usernameAvailable, emailAvailable] = await Promise.all([
                    checkUsernameAvailability(username),
                    checkEmailAvailability(email)
                ]);
                
                if (!usernameAvailable) {
                    usernameError.textContent = 'Username is already taken';
                    signupButton.disabled = false;
                    signupButton.textContent = 'Sign Up';
                    return;
                }
                
                if (!emailAvailable) {
                    emailError.textContent = 'Email is already registered';
                    signupButton.disabled = false;
                    signupButton.textContent = 'Sign Up';
                    return;
                }
                
                // Create new user
                try {
                    // First get current users
                    const getResponse = await fetch(API_URL + '/latest', {
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    });
                    
                    if (!getResponse.ok) throw new Error('Failed to fetch current users');
                    
                    const data = await getResponse.json();
                    const users = data.record.users || [];
                    
                    // Add new user
                    users.push({
                        username,
                        email,
                        password, // Note: In a real app, you should NEVER store plain text passwords
                        createdAt: new Date().toISOString()
                    });
                    
                    // Update the bin
                    const putResponse = await fetch(API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify({ users })
                    });
                    
                    if (!putResponse.ok) throw new Error('Failed to create account');
                    
                    // Redirect to homepage
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error('Error creating account:', error);
                    alert('Failed to create account. Please try again later.');
                    signupButton.disabled = false;
                    signupButton.textContent = 'Sign Up';
                }
            });
        });
    </script>
</body>
</html>
